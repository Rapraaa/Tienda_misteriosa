

# Vista de Logs de Auditoría
class AuditLogView(LoginRequiredMixin, PermissionRequiredMixin, ListView):
    """Vista para mostrar logs de auditoría de todos los modelos"""
    template_name = 'store/templates/admin/audit_log.html'
    permission_required = 'store.view_cupon'
    paginate_by = 50
    context_object_name = 'logs'
    
    def get_queryset(self):
        from django.contrib.contenttypes.models import ContentType
        
        # Obtener historial de todos los modelos
        logs = []
        
        # Cupones
        from .models import Cupon
        if hasattr(Cupon, 'history'):
            for record in Cupon.history.all()[:50]:
                logs.append({
                    'model': 'Cupón',
                    'object': record.codigo,
                    'action': self.get_action_display(record.history_type),
                    'user': record.history_user,
                    'date': record.history_date,
                    'changes': self.get_changes(record)
                })
        
        # Envios
        from .models import Envio
        if hasattr(Envio, 'history'):
            for record in Envio.history.all()[:50]:
                logs.append({
                    'model': 'Envío',
                    'object': record.codigo_rastreo_interno or f'Envío #{record.id}',
                    'action': self.get_action_display(record.history_type),
                    'user': record.history_user,
                    'date': record.history_date,
                    'changes': self.get_changes(record)
                })
        
        # Ordenar por fecha
        logs.sort(key=lambda x: x['date'], reverse=True)
        return logs[:self.paginate_by]
    
    def get_action_display(self, history_type):
        actions = {
            '+': 'Creado',
            '~': 'Modificado',
            '-': 'Eliminado'
        }
        return actions.get(history_type, 'Desconocido')
    
    def get_changes(self, record):
        """Obtiene los cambios realizados"""
        if record.history_type == '+':
            return 'Registro creado'
        elif record.history_type == '-':
            return 'Registro eliminado'
        else:
            return 'Registro modificado'
